<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transactions - Smart Finance Coach</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Base Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6fc;
      color: #2e3346;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header & Navigation */
    header {
      background-color: #0f3460;
      color: #fff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 24px;
      font-weight: 600;
    }
    .logout-btn {
      background: #e94560;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 600;
    }
    .logout-btn:hover {
      background: #b8002a;
    }

    nav.navbar {
      background: white;
      display: flex;
      padding: 12px 30px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      user-select: none;
    }
    nav.navbar a {
      color: #2e3346;
      text-decoration: none;
      margin-right: 25px;
      font-weight: 500;
      padding-bottom: 4px;
      transition: color 0.3s, border-bottom 0.3s;
      border-bottom: 3px solid transparent;
    }
    nav.navbar a.active {
      color: #0f3460;
      border-bottom: 3px solid #0f3460;
    }
    nav.navbar a:hover {
      color: #0f3460;
      border-bottom: 3px solid #0f3460;
    }

    /* Main Content */
    main {
      flex: 1;
      padding: 30px;
      max-width: 900px;
      margin: 0 auto 40px;
    }
    h2 {
      font-size: 22px;
      color: #0f3460;
      margin-bottom: 20px;
    }

    /* Summary */
    .summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .summary div {
      background: white;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      flex: 1;
      text-align: center;
    }
    .summary div span.amount {
      display: block;
      font-size: 20px;
      margin-top: 8px;
      color: #0f3460;
    }
    .summary div.expense span.amount {
      color: #e94560;
    }
    .summary div.balance span.amount {
      color: #00b894;
    }

    /* Filters & Controls */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      align-items: center;
    }
    .filters select,
    .filters input,
    .filters button {
      padding: 10px 14px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
      transition: border 0.3s, background 0.3s;
    }
    .filters select:focus,
    .filters input:focus {
      border-color: #0f3460;
      box-shadow: 0 0 6px rgba(15, 52, 96, 0.2);
    }
    .filters button {
      background: #0f3460;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    .filters button:hover {
      background: #16213e;
    }
    .filters label {
      font-weight: 500;
      margin-right: 6px;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    th,
    td {
      padding: 16px;
      text-align: left;
      font-size: 15px;
      user-select: none;
    }
    thead {
      background: #0f3460;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    tbody tr:nth-child(even) td {
      background: #f7f9fc;
    }
    .delete-btn,
    .edit-btn {
      background: #e94560;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
      margin-right: 6px;
    }
    .delete-btn:hover {
      background: #b8002a;
    }
    .edit-btn {
      background: #0984e3;
    }
    .edit-btn:hover {
      background: #065a9d;
    }

    /* Export Button */
    .export-btn {
      background: #00b894;
      border: none;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-left: auto;
      transition: background 0.3s;
    }
    .export-btn:hover {
      background: #009f77;
    }

    /* Pagination */
    .pagination {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .pagination button {
      border: none;
      background: #0f3460;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .pagination button:hover:not(:disabled) {
      background: #16213e;
    }

    /* Sort Arrows */
    th .arrow {
      margin-left: 6px;
      font-size: 12px;
      user-select: none;
    }

    /* Modal for Add/Edit */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    .modal-content h3 {
      margin-bottom: 16px;
      color: #0f3460;
    }
    .modal-content label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .modal-buttons {
      margin-top: 20px;
      text-align: right;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 10px;
      transition: background 0.3s;
    }
    .modal-buttons .save-btn {
      background: #00b894;
      color: white;
    }
    .modal-buttons .save-btn:hover {
      background: #009f77;
    }
    .modal-buttons .cancel-btn {
      background: #ccc;
      color: #444;
    }
    .modal-buttons .cancel-btn:hover {
      background: #aaa;
    }

    /* Mobile Responsive */
    @media (max-width: 600px) {
      .filters {
        flex-direction: column;
      }
      th,
      td {
        padding: 12px;
        font-size: 14px;
      }
      .export-btn,
      .logout-btn {
        font-size: 14px;
      }
      .summary {
        flex-direction: column;
        gap: 10px;
      }
      table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Smart Finance Coach</h1>
    <button class="logout-btn" id="logout-btn">Logout</button>
  </header>

  <nav class="navbar">
    <a href="index.html">Dashboard</a>
    <a href="transaction.html" class="active">Transactions</a>
    <a href="reports.html">Reports</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </nav>

  <main>
    
    <h2>Transaction History</h2>

    <div class="summary" id="summary">
      <div class="income">Income <span class="amount">₹0.00</span></div>
      <div class="expense">Expense <span class="amount">₹0.00</span></div>
      <div class="balance">Balance <span class="amount">₹0.00</span></div>
    </div>

    <div class="filters">
      <select id="filter-type">
        <option value="">All Types</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>

      <label for="filter-date-from">From:</label>
      <input type="date" id="filter-date-from" />

      <label for="filter-date-to">To:</label>
      <input type="date" id="filter-date-to" />

      <button id="btn-filter">Filter</button>
      <button id="btn-clear">Clear</button>
      <button id="btn-export" class="export-btn">Export CSV</button>
      <button id="btn-add" style="margin-left: auto; background:#0984e3;">+ Add Transaction</button>
    </div>

    <table id="transactions-table">
      <thead>
        <tr>
          <th data-col="date">Date <span class="arrow"></span></th>
          <th data-col="type">Type <span class="arrow"></span></th>
          <th data-col="category">Category <span class="arrow"></span></th>
          <th data-col="amount">Amount (₹) <span class="arrow"></span></th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modal-title">Add Transaction</h3>
      <form id="transaction-form">
        <label for="txn-date">Date</label>
        <input type="date" id="txn-date" required />

        <label for="txn-type">Type</label>
        <select id="txn-type" required>
          <option value="">Select type</option>
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>

        <label for="txn-category">Category</label>
        <input type="text" id="txn-category" placeholder="e.g. Salary, Groceries" required />

        <label for="txn-amount">Amount (₹)</label>
        <input type="number" id="txn-amount" min="0.01" step="0.01" placeholder="0.00" required />

        <div class="modal-buttons">
          <button type="button" class="cancel-btn" id="modal-cancel">Cancel</button>
          <button type="submit" class="save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) window.location.href = 'login.html';

    document.getElementById('logout-btn').onclick = () => {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    };

    document.querySelectorAll('nav.navbar a').forEach((link) => {
      link.classList.toggle(
        'active',
        link.href.includes(window.location.pathname.split('/').pop())
      );
    });

    let finances = JSON.parse(localStorage.getItem('finances_' + loggedInUser.email)) || [];
    let workingData = [...finances];
    const rowsPerPage = 8;
    let currentPage = 1;
    let sortOrder = { col: null, direction: 1 };

    const tbody = document.querySelector('#transactions-table tbody');
    const summary = document.getElementById('summary');

    function formatDate(dateStr) {
      return new Date(dateStr).toISOString().slice(0, 10);
    }

    function renderSummary() {
      const filteredData = workingData;
      const income = filteredData
        .filter((t) => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
      const expense = filteredData
        .filter((t) => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
      const balance = income - expense;

      summary.querySelector('.income .amount').textContent = `₹${income.toFixed(2)}`;
      summary.querySelector('.expense .amount').textContent = `₹${expense.toFixed(2)}`;
      summary.querySelector('.balance .amount').textContent = `₹${balance.toFixed(2)}`;
    }

    function renderTable() {
      tbody.innerHTML = '';
      const start = (currentPage - 1) * rowsPerPage;
      const pageData = workingData.slice(start, start + rowsPerPage);

      if (!pageData.length) {
        tbody.innerHTML =
          '<tr><td colspan="5" style="text-align:center;">No transactions found.</td></tr>';
        renderSummary();
        return;
      }

      pageData.forEach((item) => {
        const globalIdx = finances.indexOf(item);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.date}</td>
          <td>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</td>
          <td>${item.category}</td>
          <td>₹${item.amount.toFixed(2)}</td>
          <td>
            <button class="edit-btn" data-index="${globalIdx}">Edit</button>
            <button class="delete-btn" data-index="${globalIdx}">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      renderSummary();
      renderPagination();
      updateSortArrows();
    }

    function deleteTransaction(index) {
      if (!confirm('Delete this transaction?')) return;
      finances.splice(index, 1);
      localStorage.setItem('finances_' + loggedInUser.email, JSON.stringify(finances));
      applyFilters();
    }

    // Event delegation for delete & edit buttons
    tbody.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-btn')) {
        const idx = parseInt(e.target.dataset.index, 10);
        deleteTransaction(idx);
      }
      if (e.target.classList.contains('edit-btn')) {
        const idx = parseInt(e.target.dataset.index, 10);
        openModal('edit', idx);
      }
    });

    function applyFilters() {
      const type = document.getElementById('filter-type').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;

      workingData = finances.filter((item) => {
        const matchType = !type || item.type === type;
        const itemDate = new Date(item.date);
        const fromDate = dateFrom ? new Date(dateFrom) : null;
        const toDate = dateTo ? new Date(dateTo) : null;

        const matchFrom = !fromDate || itemDate >= fromDate;
        const matchTo = !toDate || itemDate <= toDate;

        return matchType && matchFrom && matchTo;
      });
      currentPage = 1;
      renderTable();
    }

    function clearFilters() {
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-date-from').value = '';
      document.getElementById('filter-date-to').value = '';
      workingData = [...finances];
      currentPage = 1;
      renderTable();
    }

    document.getElementById('btn-filter').onclick = () => applyFilters();
    document.getElementById('btn-clear').onclick = () => clearFilters();

    // Sorting
    document.querySelectorAll('thead th[data-col]').forEach((th) => {
      th.addEventListener('click', () => {
        const col = th.getAttribute('data-col');
        if (sortOrder.col === col) {
          sortOrder.direction = -sortOrder.direction;
        } else {
          sortOrder.col = col;
          sortOrder.direction = 1;
        }
        sortData();
        renderTable();
      });
    });

    function sortData() {
      workingData.sort((a, b) => {
        let valA = a[sortOrder.col];
        let valB = b[sortOrder.col];

        if (sortOrder.col === 'date') {
          valA = new Date(valA);
          valB = new Date(valB);
        } else if (sortOrder.col === 'amount') {
          valA = Number(valA);
          valB = Number(valB);
        } else {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        }

        if (valA < valB) return -1 * sortOrder.direction;
        if (valA > valB) return 1 * sortOrder.direction;
        return 0;
      });
    }

    function updateSortArrows() {
      document.querySelectorAll('thead th[data-col]').forEach((th) => {
        const arrow = th.querySelector('.arrow');
        if (th.getAttribute('data-col') === sortOrder.col) {
          arrow.textContent = sortOrder.direction === 1 ? '▲' : '▼';
        } else {
          arrow.textContent = '';
        }
      });
    }

    // Pagination
    const paginationEl = document.getElementById('pagination');
    function renderPagination() {
      paginationEl.innerHTML = '';
      const totalPages = Math.ceil(workingData.length / rowsPerPage);
      if (totalPages <= 1) return;

      const createBtn = (label, disabled = false, onClick) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.disabled = disabled;
        btn.addEventListener('click', onClick);
        return btn;
      };

      paginationEl.appendChild(
        createBtn('Prev', currentPage === 1, () => {
          currentPage--;
          renderTable();
        })
      );

      for (let i = 1; i <= totalPages; i++) {
        const btn = createBtn(i, false, () => {
          currentPage = i;
          renderTable();
        });
        if (i === currentPage) {
          btn.style.backgroundColor = '#00b894';
        }
        paginationEl.appendChild(btn);
      }

      paginationEl.appendChild(
        createBtn('Next', currentPage === totalPages, () => {
          currentPage++;
          renderTable();
        })
      );
    }

    // Export CSV
    document.getElementById('btn-export').onclick = () => {
      if (!workingData.length) {
        alert('No data to export.');
        return;
      }
      const headers = ['Date', 'Type', 'Category', 'Amount'];
      const rows = workingData.map(({ date, type, category, amount }) => [
        date,
        type,
        category,
        amount.toFixed(2),
      ]);

      const csvContent =
        'data:text/csv;charset=utf-8,' +
        [headers, ...rows].map((e) => e.join(',')).join('\n');

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', 'transactions.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Modal Handling
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const txnForm = document.getElementById('transaction-form');
    const txnDate = document.getElementById('txn-date');
    const txnType = document.getElementById('txn-type');
    const txnCategory = document.getElementById('txn-category');
    const txnAmount = document.getElementById('txn-amount');
    let editIndex = null;

    document.getElementById('btn-add').onclick = () => openModal('add');

    function openModal(mode, idx = null) {
      modal.classList.add('active');
      if (mode === 'add') {
        modalTitle.textContent = 'Add Transaction';
        txnForm.reset();
        editIndex = null;
      } else if (mode === 'edit') {
        modalTitle.textContent = 'Edit Transaction';
        const txn = finances[idx];
        txnDate.value = txn.date;
        txnType.value = txn.type;
        txnCategory.value = txn.category;
        txnAmount.value = txn.amount;
        editIndex = idx;
      }
    }

    document.getElementById('modal-cancel').onclick = () => {
      modal.classList.remove('active');
      editIndex = null;
    };

    txnForm.onsubmit = (e) => {
      e.preventDefault();

      const newTxn = {
        date: txnDate.value,
        type: txnType.value,
        category: txnCategory.value.trim(),
        amount: parseFloat(txnAmount.value),
      };

      if (!newTxn.date || !newTxn.type || !newTxn.category || isNaN(newTxn.amount) || newTxn.amount <= 0) {
        alert('Please fill all fields correctly.');
        return;
      }

      if (editIndex !== null) {
        finances[editIndex] = newTxn;
      } else {
        finances.push(newTxn);
      }

      localStorage.setItem('finances_' + loggedInUser.email, JSON.stringify(finances));
      workingData = [...finances];
      currentPage = 1;
      applyFilters();
      modal.classList.remove('active');
      editIndex = null;
    };

    // Initial render
    clearFilters();
  </script>
</body>
</html>
