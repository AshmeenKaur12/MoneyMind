<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Profile - Smart Finance Coach</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        /* ===================
           Global Styles
           =================== */
        :root {
            --bg-color: #e9f0ff;
            --card-color: #fff;
            --text-color: #1a1a2e;
            --header-color: #0f3460;
            --nav-color: #16213e;
            --accent-color: #e94560;
            --success-color: #00b894;
            --danger-color: #e94560;
            --progress-fill: #6c5ce7;
            --progress-bg: #e3e6e9;
            --neutral-color: #3f51b5; /* For info/secondary actions */
            --border-color: #f0f5ff;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-dark: rgba(0, 0, 0, 0.2);
        }

        body.dark {
            --bg-color: #1c1c2b;
            --card-color: #2a2a3d;
            --text-color: #f1f1f1;
            --header-color: #2a2a3d;
            --nav-color: #2a2a3d;
            --accent-color: #00b894;
            --success-color: #00b894;
            --danger-color: #e94560;
            --progress-fill: #8e7bff;
            --progress-bg: #3b3b55;
            --neutral-color: #5c6bc0;
            --border-color: #3b3b55;
            --shadow-light: rgba(0, 0, 0, 0.25);
            --shadow-dark: rgba(0, 0, 0, 0.4);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* ===================
           Header & Navigation
           =================== */
        header {
            background-color: var(--header-color);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(15, 52, 96, 0.5);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 28px;
        }

        .logout-btn {
            background: var(--danger-color);
            border: none;
            padding: 10px 22px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
        }
        
        .logout-btn:hover {
            background: #b8002a;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(184, 0, 42, 0.4);
        }

        nav.navbar {
            background: var(--nav-color);
            display: flex;
            justify-content: space-evenly;
            padding: 12px 30px;
            box-shadow: 0 2px 6px rgba(22, 33, 62, 0.6);
        }

        nav.navbar a {
            flex: 1;
            text-align: center;
            color: #d1d5db;
            font-weight: 600;
            text-decoration: none;
            font-size: 16px;
            padding-bottom: 4px;
            border-bottom: 3px solid transparent;
            transition: color 0.3s ease, border-bottom 0.3s ease;
        }

        nav.navbar a:hover,
        nav.navbar a.active {
            color: var(--accent-color);
            border-bottom: 3px solid var(--accent-color);
        }

        body.dark nav.navbar a {
            color: #cfd4e4;
        }

        body.dark nav.navbar a:hover,
        body.dark nav.navbar a.active {
            color: var(--accent-color);
            border-bottom: 3px solid var(--accent-color);
        }

        /* ===================
           Main Content
           =================== */
        main {
            padding: 40px;
            max-width: 1200px; /* Increased max-width for more content */
            width: 100%;
            margin: 40px auto;
            color: var(--text-color);
            animation: fadeInSlideUp 0.8s ease-out forwards;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
            gap: 30px;
        }

        h2 {
            grid-column: 1 / -1; /* Span across all columns */
            margin-bottom: 20px;
            color: var(--header-color);
            font-size: 32px;
            text-align: center;
        }

        body.dark h2 {
            color: #e9f0ff;
        }

        .card {
            background: var(--card-color);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px var(--shadow-light);
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-dark);
        }

        body.dark .card {
            background-color: #2a2a3d;
            box-shadow: 0 10px 30px var(--shadow-dark);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--accent-color);
            font-size: 22px;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }

        body.dark .section-header {
            color: var(--success-color);
            border-bottom: 2px solid var(--border-color);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1.6px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s ease;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent-color);
        }

        body.dark .form-group input,
        body.dark .form-group select {
            background-color: #33334d;
            color: #f1f1f1;
            border-color: #444466;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            font-size: 15px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
        }
        
        .btn-save {
            background: var(--success-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-save:hover {
            background: #00997a;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 184, 148, 0.4);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #b8002a;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(233, 69, 96, 0.4);
        }

        .btn-neutral {
            background: var(--neutral-color);
            color: white;
        }

        .btn-neutral:hover {
            background: #303f9f;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(63, 81, 181, 0.4);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
            border-left: 5px solid;
            animation: fadeIn 0.5s forwards;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #155724;
            display: block;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #721c24;
            display: block;
        }
        
        body.dark .alert.success {
            background-color: #2f2f45;
            color: var(--success-color);
            border-color: var(--success-color);
        }

        body.dark .alert.error {
            background-color: #33334d;
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            display: block;
            border: 4px solid var(--accent-color);
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        .hidden {
            display: none;
        }
        
        #goals-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease;
        }
        
        body.dark .goal-item {
            background: #1c1c2b;
            box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
        }

        .goal-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
            margin-right: 20px;
        }
        
        .goal-name {
            font-weight: 700;
        }
        
        .goal-amounts {
            font-size: 14px;
            color: #666;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        body.dark .goal-amounts {
            color: #aaa;
        }
        
        .goal-progress {
            width: 100%;
            height: 10px;
            background-color: var(--progress-bg);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .goal-progress-fill {
            height: 100%;
            background-color: var(--progress-fill);
            transition: width 0.5s ease-in-out;
        }
        
        .goal-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-add-btn, .goal-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-color);
            transition: color 0.2s ease;
        }

        .quick-add-btn:hover {
            color: var(--success-color);
        }
        
        .goal-delete-btn:hover {
            color: var(--danger-color);
        }
        
        .notification-toggle, .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .setting-item:last-child, .notification-toggle:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-label {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .label-text {
            font-weight: 600;
            font-size: 16px;
        }
        
        .label-desc {
            font-size: 14px;
            color: #777;
            margin-top: 2px;
        }

        body.dark .label-desc {
            color: #bbb;
        }

        .toggle-switch-container {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle-switch-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* New Sections */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            background: var(--bg-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        body.dark .summary-item {
            background: #1c1c2b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .summary-item .icon {
            font-size: 36px;
            color: var(--accent-color);
        }
        
        .summary-item .label {
            font-weight: 600;
            font-size: 16px;
            color: #555;
        }

        body.dark .summary-item .label {
            color: #ccc;
        }

        .summary-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
        }

        .financial-score {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent-color); /* Default */
            animation: pulse 1.5s infinite;
        }
        
        .score-good { color: var(--success-color); }
        .score-average { color: var(--neutral-color); }
        .score-poor { color: var(--danger-color); }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 20px;
            color: var(--neutral-color);
            min-width: 20px;
        }
        
        .activity-details {
            flex-grow: 1;
        }

        .activity-details .message {
            font-weight: 600;
            font-size: 15px;
        }
        
        .activity-details .timestamp {
            font-size: 13px;
            color: #999;
            margin-top: 2px;
        }
        
        body.dark .activity-details .timestamp {
            color: #bbb;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            main {
                padding: 20px;
                grid-template-columns: 1fr; /* Single column layout on small screens */
            }

            header, nav.navbar {
                padding: 15px 20px;
            }

            .card {
                padding: 20px;
            }

            .section-header {
                font-size: 20px;
                gap: 10px;
            }

            .form-group input, .form-group select, .btn {
                font-size: 14px;
                padding: 10px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===================
           Keyframe Animations
           =================== */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <header>
        <h1>Smart Finance Coach</h1>
        <button class="logout-btn" id="logout-btn">Logout</button>
    </header>

    <nav class="navbar">
        <a href="index.html">Dashboard</a>
        <a href="transaction.html">Transactions</a>
        <a href="reports.html">Reports</a>
        <a href="profile.html" class="active">Profile</a>
        <a href="settings.html">Settings</a>
    </nav>

    <main>
        <h2><i class="fa-solid fa-user-circle"></i> My Profile</h2>

        <div class="card" style="grid-column: span 2;">
            <h3 class="section-header"><i class="fa-solid fa-heart-pulse"></i> Financial Wellness Score</h3>
            <div style="text-align: center;">
                <p style="font-size: 18px; margin-bottom: 10px;">Your current financial health:</p>
                <div id="financial-score" class="financial-score score-average">--</div>
                <p id="score-message" style="font-size: 15px; color: #777; margin-top: 10px;">Calculating your score...</p>
            </div>
            <div class="summary-grid">
                <div class="summary-item">
                    <i class="fa-solid fa-piggy-bank icon"></i>
                    <span class="label">Savings Rate</span>
                    <span class="value" id="savings-rate">0%</span>
                </div>
                <div class="summary-item">
                    <i class="fa-solid fa-hand-holding-dollar icon"></i>
                    <span class="label">Debt-to-Income</span>
                    <span class="value" id="debt-income-ratio">0%</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-id-card"></i> General Information</h3>
            <img id="avatarPreview" class="profile-preview" src="https://via.placeholder.com/120" alt="Profile Picture" />
            <form id="profile-form">
                <div class="form-group">
                    <label for="profile-name">Full Name</label>
                    <input type="text" id="profile-name" required />
                </div>
                <div class="form-group">
                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email" disabled />
                </div>
                <div class="form-group">
                    <label for="profile-avatar">Profile Picture</label>
                    <input type="file" id="profile-avatar" accept="image/*" />
                </div>
                <button type="submit" class="btn btn-save"><i class="fa-solid fa-save"></i> Save Profile</button>
                <div id="profile-alert" class="alert hidden"></div>
            </form>
        </div>

        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-key"></i> Password & Security</h3>
            <button class="btn btn-neutral" id="change-password-btn"><i class="fa-solid fa-lock"></i> Change Password</button>
            <form id="password-form" class="hidden">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" required />
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" required />
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" required />
                </div>
                <button type="submit" class="btn btn-save"><i class="fa-solid fa-save"></i> Update Password</button>
                <div id="password-alert" class="alert hidden"></div>
            </form>
        </div>

        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-money-check-dollar"></i> Monthly Overview</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <i class="fa-solid fa-arrow-alt-circle-down icon" style="color: var(--success-color);"></i>
                    <span class="label">Total Income</span>
                    <span class="value" id="total-income">₹0.00</span>
                </div>
                <div class="summary-item">
                    <i class="fa-solid fa-arrow-alt-circle-up icon" style="color: var(--danger-color);"></i>
                    <span class="label">Total Expenses</span>
                    <span class="value" id="total-expenses">₹0.00</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-credit-card"></i> Debt Overview</h3>
            <div class="summary-item" style="box-shadow: none; background: none; padding: 0;">
                <i class="fa-solid fa-hand-holding-dollar icon" style="color: var(--danger-color);"></i>
                <span class="label">Total Debt</span>
                <span class="value" id="total-debt">₹0.00</span>
            </div>
            <p style="font-size: 14px; color: #777; text-align: center;" id="largest-debt-info">No significant debts recorded.</p>
        </div>

        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-piggy-bank"></i> Asset Summary</h3>
            <div class="summary-item" style="box-shadow: none; background: none; padding: 0;">
                <i class="fa-solid fa-money-bill-transfer icon" style="color: var(--success-color);"></i>
                <span class="label">Total Assets</span>
                <span class="value" id="total-assets">₹0.00</span>
            </div>
            <p style="font-size: 14px; color: #777; text-align: center;" id="largest-asset-info">No major assets recorded.</p>
        </div>

        <div class="card" style="grid-column: span 2;">
            <h3 class="section-header"><i class="fa-solid fa-bullseye"></i> My Financial Goals</h3>
            <ul id="goals-list"></ul>
            <form id="goal-form">
                <div class="form-group">
                    <label for="goal-name">Goal Name</label>
                    <input type="text" id="goal-name" placeholder="e.g., Trip to Japan" required />
                </div>
                <div class="form-group">
                    <label for="goal-target">Target Amount (₹)</label>
                    <input type="number" id="goal-target" min="0.01" step="0.01" required />
                </div>
                <div class="form-group">
                    <label for="goal-saved">Amount Saved (₹)</label>
                    <input type="number" id="goal-saved" min="0" step="0.01" value="0" />
                </div>
                <button type="submit" class="btn btn-save"><i class="fa-solid fa-plus-circle"></i> Add Goal</button>
            </form>
        </div>
        
        <div class="card" style="grid-column: span 2;">
            <h3 class="section-header"><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
            <div id="activity-feed">
                <div class="activity-item">
                    <i class="fa-solid fa-info-circle activity-icon"></i>
                    <div class="activity-details">
                        <div class="message">Welcome to Smart Finance Coach!</div>
                        <div class="timestamp">Just now</div>
                    </div>
                </div>
            </div>
            <button class="btn btn-neutral" style="margin-top: 15px;"><i class="fa-solid fa-arrow-right"></i> View All Activity</button>
        </div>

        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-database"></i> Data Management</h3>
            <div class="setting-item">
                <div class="setting-label">
                    <span class="label-text">Export My Data</span>
                    <span class="label-desc">Download a copy of your financial data.</span>
                </div>
                <button class="btn btn-neutral" id="export-btn"><i class="fa-solid fa-download"></i> Export</button>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <span class="label-text">Import My Data</span>
                    <span class="label-desc">Restore your data from a backup file.</span>
                </div>
                <input type="file" id="import-input" accept=".json" class="hidden" />
                <button class="btn btn-neutral" id="import-btn"><i class="fa-solid fa-upload"></i> Import</button>
            </div>
        </div>

        <div class="card">
            <h3 class="section-header"><i class="fa-solid fa-bell"></i> Notification Settings</h3>
            <div class="notification-toggle">
                <div class="setting-label">
                    <span class="label-text">Email Notifications</span>
                    <span class="label-desc">Receive transaction and report updates via email.</span>
                </div>
                <label class="toggle-switch-container">
                    <input type="checkbox" id="email-notifications">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="notification-toggle">
                <div class="setting-label">
                    <span class="label-text">Push Notifications</span>
                    <span class="label-desc">Get real-time alerts on your device.</span>
                </div>
                <label class="toggle-switch-container">
                    <input type="checkbox" id="push-notifications">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="card" style="grid-column: span 2;">
            <h3 class="section-header"><i class="fa-solid fa-exclamation-triangle"></i> Danger Zone</h3>
            <div class="setting-label">
                <span class="label-text">Delete My Account</span>
                <span class="label-desc">Permanently delete your account and all data. This action is irreversible.</span>
            </div>
            <button class="btn btn-danger" id="delete-account"><i class="fa-solid fa-trash-alt"></i> Delete Account</button>
            <div id="delete-alert" class="alert hidden"></div>
        </div>
    </main>

    <script>
        // Load user and users from localStorage
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        const users = JSON.parse(localStorage.getItem('users')) || [];

        if (!loggedInUser) {
            window.location.href = 'login.html';
        }
        
        // Elements
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarPreview = document.getElementById('avatarPreview');
        const profileAlert = document.getElementById('profile-alert');
        const profileForm = document.getElementById('profile-form');

        const changePasswordBtn = document.getElementById('change-password-btn');
        const passwordForm = document.getElementById('password-form');
        const passwordAlert = document.getElementById('password-alert');

        const deleteBtn = document.getElementById('delete-account');
        const deleteAlert = document.getElementById('delete-alert');
        
        const goalForm = document.getElementById('goal-form');
        const goalsList = document.getElementById('goals-list');
        
        const emailNotificationsToggle = document.getElementById('email-notifications');
        const pushNotificationsToggle = document.getElementById('push-notifications');

        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importInput = document.getElementById('import-input');

        // New Elements
        const financialScoreDisplay = document.getElementById('financial-score');
        const scoreMessageDisplay = document.getElementById('score-message');
        const savingsRateDisplay = document.getElementById('savings-rate');
        const debtIncomeRatioDisplay = document.getElementById('debt-income-ratio');
        const totalIncomeDisplay = document.getElementById('total-income');
        const totalExpensesDisplay = document.getElementById('total-expenses');
        const totalDebtDisplay = document.getElementById('total-debt');
        const largestDebtInfo = document.getElementById('largest-debt-info');
        const totalAssetsDisplay = document.getElementById('total-assets');
        const largestAssetInfo = document.getElementById('largest-asset-info');
        const activityFeed = document.getElementById('activity-feed');

        const CURRENCY_SYMBOL = '₹'; // Indian Rupee

        // Helpers
        function updateUser(updatedUser) {
            const index = users.findIndex(u => u.email === updatedUser.email);
            if (index !== -1) {
                users[index] = updatedUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        function saveLoggedInUser(user) {
            localStorage.setItem('loggedInUser', JSON.stringify(user));
        }

        function showAlert(element, message, type) {
            element.textContent = message;
            element.className = `alert ${type}`;
            setTimeout(() => {
                element.textContent = '';
                element.className = 'alert hidden';
            }, 3500);
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }

        function formatCurrency(amount) {
            return `${CURRENCY_SYMBOL}${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function formatDateTime(dateString) {
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return new Date(dateString).toLocaleString('en-IN', options);
        }
        
        // Initialization
        function initializeProfile() {
            // Load theme from settings.html
            const storedTheme = localStorage.getItem('theme') || 'light';
            setTheme(storedTheme);
            
            // Load user data
            profileName.value = loggedInUser.name;
            profileEmail.value = loggedInUser.email;
            if (loggedInUser.avatar) avatarPreview.src = loggedInUser.avatar;

            // Load notification settings
            const storedSettings = JSON.parse(localStorage.getItem('userSettings_' + loggedInUser.email)) || {};
            emailNotificationsToggle.checked = storedSettings.emailNotifications || false;
            pushNotificationsToggle.checked = storedSettings.pushNotifications || false;

            // Load finances for summaries
            loadFinancialSummaries();
            // Load goals
            renderGoals();
            // Load recent activity
            loadRecentActivity();
        }

        // Financial Data Loading and Calculations
        const userFinancesKey = 'finances_' + loggedInUser.email;
        let userFinances = JSON.parse(localStorage.getItem(userFinancesKey)) || { transactions: [] };

        function loadFinancialSummaries() {
            const transactions = userFinances.transactions;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            let totalIncome = 0;
            let totalExpenses = 0;
            let totalDebt = 0;
            let totalAssets = 0;
            let largestDebt = { name: 'N/A', amount: 0 };
            let largestAsset = { name: 'N/A', amount: 0 };

            transactions.forEach(t => {
                const transactionDate = new Date(t.date);
                if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                    } else if (t.type === 'expense') {
                        totalExpenses += t.amount;
                    }
                }

                if (t.category === 'Debt' && t.type === 'expense') { // Assuming debt payments are expenses
                    totalDebt += t.amount;
                    if (t.amount > largestDebt.amount) {
                        largestDebt = { name: t.description, amount: t.amount };
                    }
                } else if (t.category === 'Investments' || t.category === 'Savings') { // Assuming investments/savings are assets
                    totalAssets += t.amount;
                     if (t.amount > largestAsset.amount) {
                        largestAsset = { name: t.description, amount: t.amount };
                    }
                }
            });

            totalIncomeDisplay.textContent = formatCurrency(totalIncome);
            totalExpensesDisplay.textContent = formatCurrency(totalExpenses);
            totalDebtDisplay.textContent = formatCurrency(totalDebt);
            totalAssetsDisplay.textContent = formatCurrency(totalAssets);

            if (largestDebt.amount > 0) {
                largestDebtInfo.textContent = `Largest Debt: ${largestDebt.name} (${formatCurrency(largestDebt.amount)})`;
            } else {
                 largestDebtInfo.textContent = 'No significant debts recorded.';
            }

            if (largestAsset.amount > 0) {
                largestAssetInfo.textContent = `Largest Asset: ${largestAsset.name} (${formatCurrency(largestAsset.amount)})`;
            } else {
                 largestAssetInfo.textContent = 'No major assets recorded.';
            }

            calculateFinancialWellnessScore(totalIncome, totalExpenses, totalDebt, totalAssets);
        }

        function calculateFinancialWellnessScore(income, expenses, debt, assets) {
            let score = 100; // Max score
            let message = 'Excellent! Keep up the great work.';

            // Savings Rate
            const netIncome = income - expenses;
            const savingsRate = income > 0 ? (netIncome / income) * 100 : 0;
            savingsRateDisplay.textContent = `${savingsRate.toFixed(2)}%`;
            if (savingsRate < 10) {
                score -= 20;
                if (message === 'Excellent! Keep up the great work.') message = 'Good, but there\'s room to improve your savings.';
            } else if (savingsRate < 20) {
                 score -= 10;
                 if (message === 'Excellent! Keep up the great work.') message = 'Great! A solid savings rate is key.';
            }

            // Debt-to-Income Ratio
            const debtToIncomeRatio = income > 0 ? (debt / income) * 100 : 0;
            debtIncomeRatioDisplay.textContent = `${debtToIncomeRatio.toFixed(2)}%`;
            if (debtToIncomeRatio > 30) {
                score -= 30;
                if (message === 'Excellent! Keep up the great work.' || message === 'Good, but there\'s room to improve your savings.') message = 'High debt-to-income. Focus on reducing debt.';
            } else if (debtToIncomeRatio > 15) {
                score -= 15;
                if (message === 'Excellent! Keep up the great work.' || message === 'Good, but there\'s room to improve your savings.') message = 'Manageable debt, but keep an eye on it.';
            }

            // Goal Progress
            const totalGoalTarget = goals.reduce((sum, goal) => sum + goal.target, 0);
            const totalGoalSaved = goals.reduce((sum, goal) => sum + goal.saved, 0);
            const overallGoalProgress = totalGoalTarget > 0 ? (totalGoalSaved / totalGoalTarget) * 100 : 0;

            if (overallGoalProgress < 25) {
                score -= 10;
                if (message === 'Excellent! Keep up the great work.' || message === 'Good, but there\'s room to improve your savings.' || message === 'Manageable debt, but keep an eye on it.') message = 'Set clear goals and work towards them consistently.';
            } else if (overallGoalProgress < 50) {
                score -= 5;
            }

            // Set score display and message
            financialScoreDisplay.textContent = Math.max(0, score);
            if (score >= 80) {
                financialScoreDisplay.className = 'financial-score score-good';
                message = 'Excellent! Keep up the great work.';
            } else if (score >= 50) {
                financialScoreDisplay.className = 'financial-score score-average';
                if (message === 'Excellent! Keep up the great work.') message = 'Good progress, but some areas could be improved.';
            } else {
                financialScoreDisplay.className = 'financial-score score-poor';
                if (message === 'Excellent! Keep up the great work.' || message === 'Good, but there\'s room to improve your savings.' || message === 'Manageable debt, but keep an eye on it.') message = 'Time to review your finances and make some changes.';
            }
            scoreMessageDisplay.textContent = message;
        }

        // Event Listeners
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        });

        profileAvatar.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    avatarPreview.src = e.target.result;
                    loggedInUser.avatar = e.target.result;
                    updateUser(loggedInUser);
                    saveLoggedInUser(loggedInUser);
                    showAlert(profileAlert, 'Profile picture updated!', 'success');
                    addActivity('Updated profile picture', 'fa-solid fa-image');
                };
                reader.readAsDataURL(file);
            }
        });

        profileForm.addEventListener('submit', e => {
            e.preventDefault();
            const newName = profileName.value.trim();
            if (!newName) {
                showAlert(profileAlert, 'Name cannot be empty.', 'error');
                return;
            }
            loggedInUser.name = newName;
            updateUser(loggedInUser);
            saveLoggedInUser(loggedInUser);
            showAlert(profileAlert, 'Profile updated!', 'success');
            addActivity('Updated general profile information', 'fa-solid fa-id-card');
        });

        changePasswordBtn.addEventListener('click', () => {
            passwordForm.classList.toggle('hidden');
        });

        passwordForm.addEventListener('submit', e => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (currentPassword !== loggedInUser.password) {
                showAlert(passwordAlert, 'Current password is incorrect.', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert(passwordAlert, 'New password must be at least 6 characters.', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert(passwordAlert, 'New password and confirmation do not match.', 'error');
                return;
            }

            loggedInUser.password = newPassword;
            updateUser(loggedInUser);
            saveLoggedInUser(loggedInUser);

            passwordForm.reset();
            showAlert(passwordAlert, 'Password changed successfully!', 'success');
            passwordForm.classList.add('hidden');
            addActivity('Changed account password', 'fa-solid fa-key');
        });
        
        emailNotificationsToggle.addEventListener('change', () => {
            const storedSettings = JSON.parse(localStorage.getItem('userSettings_' + loggedInUser.email)) || {};
            storedSettings.emailNotifications = emailNotificationsToggle.checked;
            localStorage.setItem('userSettings_' + loggedInUser.email, JSON.stringify(storedSettings));
            addActivity(`Email notifications turned ${emailNotificationsToggle.checked ? 'on' : 'off'}`, 'fa-solid fa-bell');
        });

        pushNotificationsToggle.addEventListener('change', () => {
            const storedSettings = JSON.parse(localStorage.getItem('userSettings_' + loggedInUser.email)) || {};
            storedSettings.pushNotifications = pushNotificationsToggle.checked;
            localStorage.setItem('userSettings_' + loggedInUser.email, JSON.stringify(storedSettings));
            addActivity(`Push notifications turned ${pushNotificationsToggle.checked ? 'on' : 'off'}`, 'fa-solid fa-bell');
        });

        deleteBtn.addEventListener('click', () => {
            if (!confirm('Are you sure? This will permanently delete your account and all data. This action is irreversible.')) return;

            const index = users.findIndex(u => u.email === loggedInUser.email);
            if (index !== -1) {
                users.splice(index, 1);
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('finances_' + loggedInUser.email);
                localStorage.removeItem('goals_' + loggedInUser.email);
                localStorage.removeItem('userSettings_' + loggedInUser.email);
                localStorage.removeItem('activity_' + loggedInUser.email);

                showAlert(deleteAlert, 'Account deleted.', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });
        
        // Financial Goals Logic
        const userGoalsKey = 'goals_' + loggedInUser.email;
        let goals = JSON.parse(localStorage.getItem(userGoalsKey)) || [];

        function renderGoals() {
            goalsList.innerHTML = '';
            if (goals.length === 0) {
                goalsList.innerHTML = '<p style="text-align: center; color: #777;">You have no goals set yet. Start by adding one!</p>';
                return;
            }

            goals.forEach((goal, index) => {
                const li = document.createElement('li');
                li.className = 'goal-item';
                const progress = (goal.saved / goal.target) * 100;
                li.innerHTML = `
                    <div class="goal-details">
                        <span class="goal-name">${goal.name}</span>
                        <div class="goal-progress">
                            <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                        </div>
                        <span class="goal-amounts">${formatCurrency(goal.saved)} / ${formatCurrency(goal.target)}</span>
                    </div>
                    <div class="goal-actions">
                         <button class="quick-add-btn" data-index="${index}" title="Add ₹100">+₹100</button>
                        <button class="goal-delete-btn" data-index="${index}" title="Delete Goal"><i class="fa-solid fa-trash-alt"></i></button>
                    </div>
                `;
                goalsList.appendChild(li);
            });
            calculateFinancialWellnessScore(
                parseFloat(totalIncomeDisplay.textContent.replace(CURRENCY_SYMBOL, '')),
                parseFloat(totalExpensesDisplay.textContent.replace(CURRENCY_SYMBOL, '')),
                parseFloat(totalDebtDisplay.textContent.replace(CURRENCY_SYMBOL, '')),
                parseFloat(totalAssetsDisplay.textContent.replace(CURRENCY_SYMBOL, ''))
            );
        }

        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const goalName = document.getElementById('goal-name').value;
            const goalTarget = parseFloat(document.getElementById('goal-target').value);
            const goalSaved = parseFloat(document.getElementById('goal-saved').value) || 0;

            if (goalName && goalTarget > 0) {
                goals.push({ name: goalName, target: goalTarget, saved: goalSaved, dateCreated: new Date().toISOString() });
                localStorage.setItem(userGoalsKey, JSON.stringify(goals));
                renderGoals();
                goalForm.reset();
                addActivity(`Added new financial goal: "${goalName}"`, 'fa-solid fa-bullseye');
            }
        });

        goalsList.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const index = parseInt(target.dataset.index, 10);
            
            if (target.classList.contains('goal-delete-btn')) {
                if (confirm('Are you sure you want to delete this goal?')) {
                    const deletedGoalName = goals[index].name;
                    goals.splice(index, 1);
                    localStorage.setItem(userGoalsKey, JSON.stringify(goals));
                    renderGoals();
                    addActivity(`Deleted financial goal: "${deletedGoalName}"`, 'fa-solid fa-trash-alt');
                }
            } else if (target.classList.contains('quick-add-btn')) {
                 if (goals[index]) {
                    goals[index].saved += 100;
                    localStorage.setItem(userGoalsKey, JSON.stringify(goals));
                    renderGoals();
                    addActivity(`Added ${formatCurrency(100)} to goal: "${goals[index].name}"`, 'fa-solid fa-sack-dollar');
                 }
            }
        });
        
        // Data Management Functions
        exportBtn.addEventListener('click', () => {
            const data = {
                finances: userFinances,
                goals: goals,
                settings: JSON.parse(localStorage.getItem('userSettings_' + loggedInUser.email)) || {},
                activity: JSON.parse(localStorage.getItem('activity_' + loggedInUser.email)) || [],
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smart_finance_data_${loggedInUser.email.split('@')[0]}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Your financial data has been exported successfully!");
            addActivity('Exported all financial data', 'fa-solid fa-download');
        });

        importBtn.addEventListener('click', () => {
            importInput.click();
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (importedData.finances && importedData.goals) {
                        localStorage.setItem('finances_' + loggedInUser.email, JSON.stringify(importedData.finances));
                        localStorage.setItem('goals_' + loggedInUser.email, JSON.stringify(importedData.goals));
                        if (importedData.settings) {
                           localStorage.setItem('userSettings_' + loggedInUser.email, JSON.stringify(importedData.settings));
                        }
                        if (importedData.activity) {
                            localStorage.setItem('activity_' + loggedInUser.email, JSON.stringify(importedData.activity));
                        }
                        
                        // Reload data on the page
                        userFinances = importedData.finances;
                        goals = importedData.goals;
                        initializeProfile();
                        alert("Data imported successfully! The page will now refresh.");
                        addActivity('Imported financial data from backup', 'fa-solid fa-upload');
                        window.location.reload(); // Reload the page to apply all changes
                    } else {
                        throw new Error("Invalid file format. Missing 'finances' or 'goals' data.");
                    }
                } catch (error) {
                    alert("Failed to import data. Please ensure the file is a valid Smart Finance Coach JSON export. Error: " + error.message);
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
        });

        // Recent Activity Logic
        const userActivityKey = 'activity_' + loggedInUser.email;
        let activityLog = JSON.parse(localStorage.getItem(userActivityKey)) || [];

        function addActivity(message, iconClass = 'fa-solid fa-info-circle') {
            const newActivity = {
                message: message,
                icon: iconClass,
                timestamp: new Date().toISOString()
            };
            activityLog.unshift(newActivity); // Add to the beginning
            activityLog = activityLog.slice(0, 10); // Keep only the last 10 activities
            localStorage.setItem(userActivityKey, JSON.stringify(activityLog));
            renderActivityFeed();
        }

        function renderActivityFeed() {
            activityFeed.innerHTML = '';
            if (activityLog.length === 0) {
                activityFeed.innerHTML = `
                    <div class="activity-item">
                        <i class="fa-solid fa-info-circle activity-icon"></i>
                        <div class="activity-details">
                            <div class="message">No recent activity.</div>
                            <div class="timestamp"></div>
                        </div>
                    </div>
                `;
                return;
            }

            activityLog.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                div.innerHTML = `
                    <i class="${activity.icon} activity-icon"></i>
                    <div class="activity-details">
                        <div class="message">${activity.message}</div>
                        <div class="timestamp">${formatDateTime(activity.timestamp)}</div>
                    </div>
                `;
                activityFeed.appendChild(div);
            });
        }
        
        function loadRecentActivity() {
            renderActivityFeed();
            // Add a default welcome message if no other activity
            if (activityLog.length === 0) {
                 addActivity('Welcome to Smart Finance Coach!', 'fa-solid fa-hand-sparkles');
            }
        }

        // Initialize on load
        initializeProfile();

    </script>
</body>
</html>